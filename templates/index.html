<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YOLO + DeepSORT + DeepFace Live Detection</title>
  <style>
    body {
      background: #0e0e0e;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    video, img {
      border-radius: 10px;
      border: 3px solid #333;
      width: 80%;
      max-width: 900px;
      background-color: black;
      margin-top: 10px;
    }
    h2 {
      margin-bottom: 20px;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #logs {
      margin-top: 25px;
      width: 80%;
      max-width: 900px;
      background: #111;
      padding: 15px;
      border-radius: 10px;
      overflow-y: auto;
      height: 180px;
      font-size: 14px;
      border: 1px solid #333;
    }
    #logs p {
      margin: 4px 0;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>YOLO + DeepSORT + DeepFace Live Detection</h2>

  <!-- Local webcam feed (visible now) -->
  <video id="localVideo" autoplay playsinline muted></video>

  <!-- Processed video stream (from backend) -->
  <img id="processedVideo" alt="Processed Stream" />

  <button id="startBtn">Start Detection</button>
  <div id="logs"></div>

  <script>
    const video = document.getElementById("localVideo");
    const processedImg = document.getElementById("processedVideo");
    const logsDiv = document.getElementById("logs");
    const startBtn = document.getElementById("startBtn");

    let streaming = false;

    function logMessage(msg) {
      const p = document.createElement("p");
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logsDiv.appendChild(p);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await new Promise(resolve => video.onloadedmetadata = resolve);
        logMessage("Camera started.");
        return true;
      } catch (err) {
        logMessage("Camera access error: " + err.message);
        return false;
      }
    }

    let frameCount = 0; // add this outside the function, globally

    async function sendFrame() {
      if (!streaming) return;

      frameCount++;

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Only send every 5th frame
      if (frameCount % 5 === 0) {
        const dataUrl = canvas.toDataURL("image/jpeg", 0.8);

        try {
          const response = await fetch("/process_frame", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: dataUrl })
          });

          const result = await response.json();

          if (result.processed_image) {
            processedImg.src = result.processed_image;
          }

          if (result.detections) {
            logMessage(`Detections: ${result.logs}`);
          }
        } catch (err) {
          logMessage("Error sending frame: " + err.message);
        }
      }

      // Keep looping ~3 FPS (you can adjust if needed)
      setTimeout(sendFrame, 300);
    }

    startBtn.onclick = async () => {
      if (!streaming) {
        const ok = await startCamera();
        if (ok) {
          streaming = true;
          startBtn.textContent = "Stop Detection";
          logMessage("Starting detection loop...");
          sendFrame();
        }
      } else {
        streaming = false;
        startBtn.textContent = "Start Detection";
        logMessage("Detection stopped.");
      }
    };
  </script>
</body>
</html>
